<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>지뢰 찾기</title>

  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <!-- 시작 화면 -->
  <div class="container">
    <h1>지뢰 찾기</h1>
    <div id="ready">
      <p>지뢰 찾기를 해봅시다</p>
      <button id="start-btn">시작</button>
    </div>
  
    <div id="start">
      <table id="table">
        <tbody></tbody>
      </table>
      <div id="result"></div>
    </div>
  </div>

  <script>
    const $ready = document.querySelector('#ready');
    const $start = document.querySelector('#start');

    const $tbody  = document.querySelector('#table tbody');
    const $result = document.querySelector('#result');

    const row  = 10; // 줄
    const cell = 10; // 칸
    const mine = 10; // 지뢰수
    const CODE = {
      NORMAL: -1,
      QUESTION: -2,
      FLAG: -3,
      QUESTION_MINE: -4,
      FLAG_MINE: -5,
      MINE: -6,
      OPENED: 0, // 0 이상이면 모두 열린 칸
    }
    let data;
    let openCount = 0;

    const plantMine = () => {
      // 전체 칸 만들어 순서대로 숫자 넣기
      const candidate = Array(row * cell).fill().map((arr, i) => {
        return i;
      });

      // 섞기
      const shuffle = [];
      while (candidate.length > row * cell - mine) { // 100개에서 90개가 될 때 까지
        // 전체에서 랜덤한 값을 추출하기
        const chosen = candidate.splice(Math.floor(Math.random() * candidate.length), 1)[0];
        shuffle.push(chosen);
      }

      // 전체 값을 NORMAL 값으로 채우기
      const data = [];
      for (let i = 0; i < row; i++) {
        // 한 줄
        const rowData = [];
        data.push(rowData);
        for (let j = 0; j < cell; j++) {
          // 한 칸
          rowData.push(CODE.NORMAL);
        }
      }

      // 지뢰 심기
      for (let k = 0; k < shuffle.length; k++) {
        const ver = Math.floor(shuffle[k] / cell); // 가로
        const hor = shuffle[k] % cell; //세로
        data[ver][hor] = CODE.MINE;
      }

      return data;
    };

    const onRightClick = (event) => {
      event.preventDefault();

      const target = event.target;
      const rowIndex = target.parentNode.rowIndex;
      const cellIndex = target.cellIndex;

      const cellData = data[rowIndex][cellIndex];
      if (cellData === CODE.MINE) { // 지뢰면
        data[rowIndex][cellIndex] = CODE.QUESTION_MINE; // 물음표 지뢰로
        target.className = 'question';
        target.textContent = '?';
      } else if (cellData === CODE.QUESTION_MINE) { // 물음표 지뢰면
        data[rowIndex][cellIndex] = CODE.FLAG_MINE; // 깃발 지뢰로
        target.className = 'flag';
        target.textContent = '!';
      } else if (cellData === CODE.FLAG_MINE) { // 깃발 지뢰면
        data[rowIndex][cellIndex] = CODE.MINE; // 지뢰로
        target.className = '';
        target.textContent = 'X';
      } else if (cellData === CODE.NORMAL) { // 닫힌 칸이면
        data[rowIndex][cellIndex] = CODE.QUESTION; // 물음표로
        target.className = 'question';
        target.textContent = '?';
      } else if (cellData === CODE.QUESTION) { // 물음표면
        data[rowIndex][cellIndex] = CODE.FLAG; // 깃발으로
        target.className = 'flag';
        target.textContent = '!';
      } else if (cellData === CODE.FLAG) { // 깃발이면
        data[rowIndex][cellIndex] = CODE.NORMAL; // 닫힌 칸으로
        target.className = '';
        target.textContent = '';
      }
    }

    const countMine = (rowIndex, cellIndex) => {
      const mines = [CODE.MINE, CODE.QUESTION_MINE, CODE.FLAG_MINE];
      let count = 0;

      for(let i = (rowIndex - 1); i <= (rowIndex + 1); i++) {
        for(let j = (cellIndex - 1); j <= (cellIndex + 1); j++) {
          mines.includes(data[i]?.[j]) && count++; // ?. 옵셔널 체이닝(optional chaining) 연산자
        }
      }

      /* // for문 대신 사용 가능
      mines.includes(data[rowIndex - 1]?.[cellIndex - 1]) && count++;
      mines.includes(data[rowIndex - 1]?.[cellIndex]) && count++;
      mines.includes(data[rowIndex - 1]?.[cellIndex + 1]) && count++;
      mines.includes(data[rowIndex][cellIndex - 1]) && count++;
      mines.includes(data[rowIndex][cellIndex + 1]) && count++;
      mines.includes(data[rowIndex + 1]?.[cellIndex - 1]) && count++;
      mines.includes(data[rowIndex + 1]?.[cellIndex]) && count++;
      mines.includes(data[rowIndex + 1]?.[cellIndex + 1]) && count++;
      */

      return count;
    }

    const open = (rowIndex, cellIndex) => {
      // 열린 칸은 다시 열지 않기
      if (data[rowIndex]?.[cellIndex] >= CODE.OPENED) return;

      const target = $tbody.children[rowIndex]?.children[cellIndex];
      
      // 열을 값이 없다면 return
      if (!target) return;

      const count = countMine(rowIndex, cellIndex);
      target.textContent = count || '';
      target.className = 'opened';
      data[rowIndex][cellIndex] = count;

      openCount++;
      console.log(openCount);
      return count;
    }

    const openAround = (rI, cI) => {
      const count = open(rI, cI);

      // 주변 count값이 0인 경우 또 열어주기
      if (count === 0) {
        openAround(rI - 1, cI - 1);
        openAround(rI - 1, cI);
        openAround(rI - 1, cI + 1);
        openAround(rI, cI - 1);
        openAround(rI, cI + 1);
        openAround(rI + 1, cI - 1);
        openAround(rI + 1, cI);
        openAround(rI + 1, cI + 1);
      }
    }

    const onLeftClick = (event) => {
      const target = event.target;
      const rowIndex = target.parentNode.rowIndex;
      const cellIndex = target.cellIndex;

      const cellData = data[rowIndex][cellIndex];
      if(cellData === CODE.NORMAL) {
        // 닫힌 칸
        openAround(rowIndex, cellIndex);

      } else if(cellData === CODE.MINE) {
        // 지뢰 클릭 게임 끝
        target.textContent = '펑';
        target.className = 'opened';

        // 이벤트 리스너 삭제
        $tbody.removeEventListener('contextmenu', onRightClick);
        $tbody.removeEventListener('click', onLeftClick);

      }
    }

    const makeTable = () => {
      $tbody.innerHTML = '';
      data = plantMine();
      console.log(data);

      data.forEach(row => {
        const $tr = document.createElement('tr');

        row.forEach((cell) => {
          const $td = document.createElement('td');
          if (cell === CODE.MINE) {
            $td.textContent = '*'; // 개발 편의를 위해
          }
          $tr.append($td);
        });
        $tbody.addEventListener('contextmenu', onRightClick);
        $tbody.addEventListener('click', onLeftClick);
        $tbody.append($tr);
      });
    };

    function startGame() {
      makeTable();
    }

    function resetGame() {

      startGame();
    }
    

    const $startBtn = document.querySelector('#start-btn');
    $startBtn.addEventListener('click', startGame);

    const button = document.createElement('button');
    button.addEventListener('click', resetGame);
    button.textContent = '다시하기';
  </script>
</body>
</html>